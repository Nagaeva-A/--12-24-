#include <iostream>
#include <iomanip>

// Функция для отображения главного меню
void show_menu() {
    std::cout << "\n========================================\n";
    std::cout << "          ГЛАВНОЕ МЕНЮ\n";
    std::cout << "========================================\n";
    std::cout << "1. Расчет себестоимости продукции\n";
    std::cout << "2. Тестирование программы\n";
    std::cout << "3. Выход\n";
    std::cout << "========================================\n";
    std::cout << "Выберите пункт меню (1-3): ";
}

// Функция для расчета себестоимости
void calculate_cost() {
    std::cout << "\n=== РЕЖИМ РАСЧЕТА СЕБЕСТОИМОСТИ ===\n\n";
    
    double material, labor, amortization, other, units, price;
    
    // Ввод материальных затрат
    while (true) {
        std::cout << "Введите материальные затраты: ";
        std::cin >> material;
        if (material < 0) {
            std::cout << "Ошибка! Затраты не могут быть отрицательными.Попробуйте еще раз.\n";
        } else {
            break;
        }
    }
    
    // Ввод оплаты труда
    while (true) {
        std::cout << "Введите оплату труда: ";
        std::cin >> labor;
        if (labor < 0) {
            std::cout << "Ошибка! Затраты не могут быть отрицательными.Попробуйте еще раз.\n";
        } else {
            break;
        }
    }
    
    // Ввод амортизации
    while (true) {
        std::cout << "Введите амортизацию: ";
        std::cin >> amortization;
        if (amortization < 0) {
            std::cout << "Ошибка! Затраты не могут быть отрицательными.Попробуйте еще раз.\n";
        } else {
            break;
        }
    }
    
    // Ввод прочих затрат
    while (true) {
        std::cout << "Введите прочие затраты: ";
        std::cin >> other;
        if (other < 0) {
            std::cout << "Ошибка! Затраты не могут быть отрицательными.Попробуйте еще раз.\n";
        } else {
            break;
        }
    }
    
    // Ввод количества единиц
    while (true) {
        std::cout << "Введите количество единиц продукции: ";
        std::cin >> units;
        if (units <= 0) {
            std::cout << "Ошибка! Количество должно быть больше 0.Попробуйте еще раз.\n";
        } else {
            break;
        }
    }
    
    // Ввод цены реализации
    while (true) {
        std::cout << "Введите цену реализации за единицу: ";
        std::cin >> price;
        if (price <= 0) {
            std::cout << "Ошибка! Цена должна быть больше 0.Попробуйте еще раз\n";
        } else {
            break;
        }
    }
    
    // Расчеты
    double total_cost = material + labor + amortization + other;
    double cost_per_unit = total_cost / units;
    double margin = (price > 0) ? ((price - cost_per_unit) / price) * 100.0 : 0.0;
    
    // Вывод результатов
    std::cout << "\n=== РЕЗУЛЬТАТЫ РАСЧЕТА ===\n";
    std::cout << "Себестоимость: " << std::fixed << std::setprecision(0) << total_cost << " руб.\n";
    std::cout << "Себестоимость единицы: " << std::fixed << std::setprecision(2) << cost_per_unit << " руб.\n";
    std::cout << "Маржинальность: " << std::fixed << std::setprecision(2) << margin << "%\n";
    
    // Анализ рентабельности
    std::cout << "\n=== АНАЛИЗ РЕНТАБЕЛЬНОСТИ ===\n";
    if (margin < 0) {
        std::cout << " Производство УБЫТОЧНО\n";
    } else if (margin == 0) {
        std::cout << "  Производство работает В НОЛЬ\n";
    } else if (margin < 10) {
        std::cout << " НИЗКАЯ рентабельность\n";
    } else if (margin < 20) {
        std::cout << " СРЕДНЯЯ рентабельность\n";
    } else {
        std::cout << " ВЫСОКАЯ рентабельность\n";
    }
    
    // Анализ структуры затрат
    if (total_cost > 0) {
        std::cout << "\n=== СТРУКТУРА ЗАТРАТ ===\n";
        std::cout << "Материалы: " << std::fixed << std::setprecision(1) 
                  << (material / total_cost * 100) << "%\n";
        std::cout << "Оплата труда: " << (labor / total_cost * 100) << "%\n";
        std::cout << "Амортизация: " << (amortization / total_cost * 100) << "%\n";
        std::cout << "Прочие затраты: " << (other / total_cost * 100) << "%\n";
    }
}

// Функция для тестирования программы
void run_tests() {
    std::cout << "\n=== РЕЖИМ ТЕСТИРОВАНИЯ ===\n";
    std::cout << "Запуск автоматических тестов...\n\n";
    
    // Тест 1: Пример
    std::cout << "ТЕСТ 1: Высокая рентабельность производства\n";
    std::cout << "Входные данные: 45000, 60000, 30000, 15000, 3000, 80\n";
    double total1 = 45000 + 60000 + 30000 + 15000;
    double unit_cost1 = total1 / 3000;
    double margin1 = ((80 - unit_cost1) / 80) * 100;
    std::cout << "Ожидаемый результат: Себестоимость=150000, Себестоимость единицы=50.00, Маржинальность=37.50%\n";
    std::cout << "Фактический результат: Себестоимость=" << total1 
              << ", Себестоимость единицы=" << std::fixed << std::setprecision(2) << unit_cost1
              << ", Маржинальность=" << margin1 << "%\n";
    std::cout << (std::abs(margin1 - 20.00) > 0.01 ? " ТЕСТ ПРОЙДЕН\n\n" : " ТЕСТ НЕ ПРОЙДЕН\n\n");
    
    // Тест 2: Пример 
    std::cout << "ТЕСТ 2: Низкая рентабельность производства.\n";
    std::cout << "Входные данные: 85000, 30000, 15000, 10000, 5000, 30\n";
    double total2 = 85000 + 30000 + 15000 + 10000;
    double unit_cost2 = total2 / 5000;
    double margin2 = ((30 - unit_cost2) / 30) * 100;
    std::cout << "Ожидаемый результат: Себестоимость=140000, Себестоимость единицы=28.00, Маржинальность=6.67%\n";
    std::cout << "Фактический результат: Себестоимость=" << total2 
              << ", Себестоимость единицы=" << unit_cost2
              << ", Маржинальность=" << margin2 << "%\n";
    std::cout << (std::abs(margin2 - 10.00) > 0.01 ? " ТЕСТ ПРОЙДЕН\n\n" : " ТЕСТ НЕ ПРОЙДЕН\n\n");
    
    // Тест 3: Проверка на убыточность
    std::cout << "ТЕСТ 3: Убыточное производство\n";
    std::cout << "Входные данные: 10000, 5000, 2000, 1000, 100, 50\n";
    double total3 = 10000 + 5000 + 2000 + 1000;
    double unit_cost3 = total3 / 100;
    double margin3 = ((50 - unit_cost3) / 50) * 100;
    std::cout << "Ожидаемый результат: Отрицательная маржинальность\n";
    std::cout << "Фактический результат: Маржинальность=" << margin3 << "%\n";
    std::cout << (margin3 < 0 ? " ТЕСТ ПРОЙДЕН\n\n" : " ТЕСТ НЕ ПРОЙДЕН\n\n");
    
    // Тест 4: Проверка деления на ноль
    std::cout << "ТЕСТ 4: Нулевая цена реализации\n";
    std::cout << "Входные данные: 1000, 500, 200, 100, 10, 0\n";
    double margin4 = 0.0; // При цене 0 маржинальность = 0
    std::cout << "Ожидаемый результат: Маржинальность=0.00%\n";
    std::cout << "Фактический результат: Маржинальность=" << margin4 << "%\n";
    std::cout << (margin4 == 0 ? " ТЕСТ ПРОЙДЕН\n\n" : " ТЕСТ НЕ ПРОЙДЕН\n\n");
    
    std::cout << "=== ТЕСТИРОВАНИЕ ЗАВЕРШЕНО ===\n";
}

int main() {
    setlocale(LC_ALL, "Russian");
    
    std::cout << "========================================\n";
    std::cout << "  КАЛЬКУЛЯТОР СЕБЕСТОИМОСТИ ПРОДУКЦИИ  \n";
    std::cout << "========================================\n";
    
    int choice;
    
    while (true) {
        show_menu();
        std::cin >> choice;
        
        switch (choice) {
            case 1:
                calculate_cost();
                break;
            case 2:
                run_tests();
                break;
            case 3:
                std::cout << "\nПрограмма завершена. До свидания!\n";
                return 0;
            default:
                std::cout << "\nОшибка! Введите число от 1 до 3.\n";
                // Очистка буфера ввода при ошибке
                std::cin.clear();
                std::cin.ignore(10000, '\n');
        }
    }
    
    return 0;
}
